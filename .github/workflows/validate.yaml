---
name: Validate

on:
  push:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  list-configs:
    name: Get Changed Configs Summary
    runs-on: ubuntu-latest
    outputs:
      configs: ${{ steps.collect.outputs.configs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: bjw-s-labs/action-changed-files@1a5aeab1bfa64d0c4e786f501d5a3f1fad4a24da # v0.4.1
        with:
          patterns: |-
            **/*.yaml
            **/*.yml

      - name: Collect config files
        id: collect
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.changed_files }}
        run: |
          python <<'PY'
          import json
          import os
          from pathlib import Path

          changed_files_str = os.environ.get("CHANGED_FILES", "[]")
          try:
              changed_files = json.loads(changed_files_str)
          except json.JSONDecodeError:
              changed_files = []

          if not isinstance(changed_files, list):
              changed_files = []

          def first_friendly_name(path_str: str) -> str | None:
            try:
                path = Path(path_str)
                if not path.exists():
                    return None
                with path.open("r", encoding="utf-8", errors="ignore") as f:
                  for raw in f:
                    line = raw.strip()
                    if not line or line.startswith("#"):
                      continue
                    if line.startswith("friendly_name:"):
                      value = line.split(":", 1)[1].strip()
                      if (value.startswith('"') and value.endswith('"')) or (
                        value.startswith("'") and value.endswith("'")
                      ):
                        value = value[1:-1].strip()
                      return value or None
            except Exception:
                pass
            return None

          configs = []

          for f in changed_files:
            friendly_name = first_friendly_name(f)
            if not friendly_name:
              continue

            configs.append(
              {
                "file": f,
                "friendly_name": friendly_name,
              }
            )

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
            fh.write(f"configs={json.dumps(configs)}\n")
          PY

      - name: Generate Summary
        uses: actions/github-script@v7
        env:
          CONFIGS: ${{ steps.collect.outputs.configs }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.changed_files }}
        with:
          script: |
            const configs = JSON.parse(process.env.CONFIGS || '[]');
            const changedFiles = JSON.parse(process.env.CHANGED_FILES || '[]');

            // Find files that were changed but don't have friendly_name (not ESPHome configs)
            const skippedFiles = changedFiles.filter(file =>
              !configs.some(config => config.file === file) &&
              (file.endsWith('.yaml') || file.endsWith('.yml')) &&
              !file.includes('secrets.yaml') &&
              !file.includes('.github/')
            );

            let summaryText = '';

            if (configs.length === 0) {
              summaryText += 'No ESPHome configs to validate\n\n';
              if (changedFiles.length > 0) {
                summaryText += `Changed files: ${changedFiles.length}\n`;
                summaryText += `ESPHome configs: 0\n\n`;
              }
            } else {
              summaryText += 'Configs to test:\n';
              configs.forEach(config => {
                summaryText += `- ${config.friendly_name} ('${config.file}')\n`;
              });
              summaryText += '\n';
            }

            if (skippedFiles.length > 0) {
              summaryText += 'Skipped files (not ESPHome configs):\n';
              skippedFiles.forEach(file => {
                summaryText += `- ${file} (no friendly_name found)\n`;
                core.warning(`File ${file} appears to be a YAML file but doesn't contain a friendly_name - skipping validation`);
              });
              summaryText += '\n';
            }

            core.summary.addRaw(summaryText).write();

  validate:
    name: Validate ESPHome configs
    runs-on: ubuntu-latest
    needs: list-configs
    if: needs.list-configs.outputs.configs != '[]'
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.list-configs.outputs.configs) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install ESPHome
        run: pip install esphome

      - name: Provide stub secrets.yaml
        run: |
          cat > secrets.yaml <<'EOF'
          wifi_ssid: "dummy-ssid"
          wifi_password: "dummy-password"
          api_key: "NTaJhzu9F3FQQW/TBqjSkr50euZwR/Po6Op50tmceiw="
          ota_password: "dummy-ota-password"
          EOF

      - name: Validate config
        id: validate
        run: |
          set -o pipefail
          esphome config "${{ matrix.config.file }}" 2>&1 | tee esphome.log

      - name: Add result to summary
        if: always()
        uses: actions/github-script@v7
        env:
          CONFIG_NAME: ${{ matrix.config.friendly_name }}
          CONFIG_FILE: ${{ matrix.config.file }}
          JOB_STATUS: ${{ job.status }}
        with:
          script: |-
            const {
              CONFIG_NAME,
              CONFIG_FILE,
              JOB_STATUS,
            } = process.env;

            const ok = JOB_STATUS === 'success';
            const icon = ok ? '✅' : '❌';

            let summary = `${icon} ${CONFIG_NAME} (\`${CONFIG_FILE}\`) - ${JOB_STATUS}\n\n`;

            core.summary.addRaw(summary).write();
