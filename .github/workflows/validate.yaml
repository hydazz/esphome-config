---
name: Validate

on:
  push:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  list-configs:
    name: Discover changed ESPHome configs
    runs-on: ubuntu-latest
    outputs:
      configs: ${{ steps.collect.outputs.configs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: bjw-s-labs/action-changed-files@1a5aeab1bfa64d0c4e786f501d5a3f1fad4a24da # v0.4.1
        with:
          patterns: |-
            **/*.yaml
            **/*.yml

      - name: Collect config files
        id: collect
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.changed_files }}
        run: |
          python <<'PY'
          import json
          import os
          from pathlib import Path

          changed_files_str = os.environ.get("CHANGED_FILES", "[]")
          try:
              changed_files = json.loads(changed_files_str)
          except json.JSONDecodeError:
              changed_files = []

          if not isinstance(changed_files, list):
              changed_files = []

          def first_friendly_name(path_str: str) -> str | None:
            try:
                path = Path(path_str)
                if not path.exists():
                    return None
                with path.open("r", encoding="utf-8", errors="ignore") as f:
                  for raw in f:
                    line = raw.strip()
                    if not line or line.startswith("#"):
                      continue
                    if line.startswith("friendly_name:"):
                      value = line.split(":", 1)[1].strip()
                      if (value.startswith('"') and value.endswith('"')) or (
                        value.startswith("'") and value.endswith("'")
                      ):
                        value = value[1:-1].strip()
                      return value or None
            except Exception:
                pass
            return None

          configs = []

          for f in changed_files:
            friendly_name = first_friendly_name(f)
            if not friendly_name:
              continue

            configs.append(
              {
                "file": f,
                "friendly_name": friendly_name,
              }
            )

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
            fh.write(f"configs={json.dumps(configs)}\n")
          PY

      - name: Generate Summary
        uses: actions/github-script@v7
        env:
          CONFIGS: ${{ steps.collect.outputs.configs }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.changed_files }}
        with:
          script: |
            const configs = JSON.parse(process.env.CONFIGS || '[]');
            const changedFiles = JSON.parse(process.env.CHANGED_FILES || '[]');

            // Find files that were changed but don't have friendly_name (not ESPHome configs)
            const skippedFiles = changedFiles.filter(file =>
              !configs.some(config => config.file === file) &&
              (file.endsWith('.yaml') || file.endsWith('.yml')) &&
              !file.includes('secrets.yaml') &&
              !file.includes('.github/')
            );

            let summaryText = '';

            if (configs.length === 0) {
              summaryText += '## üîç ESPHome Configuration Validation\n\n';
              summaryText += '### ‚ÑπÔ∏è No ESPHome configs to validate\n\n';
              if (changedFiles.length > 0) {
                summaryText += `**Changed files:** ${changedFiles.length}\n`;
                summaryText += `**ESPHome configs:** 0\n\n`;
              }
            } else {
              const configList = configs.map(config => `- **${config.friendly_name}** (\`${config.file}\`)`);

              summaryText += '## üîç ESPHome Configuration Validation\n\n';
              summaryText += '### üìã Configs to validate:\n\n';
              summaryText += configList.join('\n') + '\n\n';
              summaryText += `**Total configs:** ${configs.length}\n\n`;
            }

            if (skippedFiles.length > 0) {
              summaryText += '### ‚ö†Ô∏è Skipped files (not ESPHome configs):\n\n';
              skippedFiles.forEach(file => {
                summaryText += `- \`${file}\` (no friendly_name found)\n`;
                core.warning(`File ${file} appears to be a YAML file but doesn't contain a friendly_name - skipping validation`);
              });
              summaryText += '\n';
            }

            core.summary.addRaw(summaryText).write();

  validate:
    name: Validate ESPHome configs
    runs-on: ubuntu-latest
    needs: list-configs
    if: needs.list-configs.outputs.configs != '[]'
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.list-configs.outputs.configs) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install ESPHome
        run: pip install esphome

      - name: Provide stub secrets.yaml
        run: |
          cat > secrets.yaml <<'EOF'
          wifi_ssid: "dummy-ssid"
          wifi_password: "dummy-password"
          api_key: "NTaJhzu9F3FQQW/TBqjSkr50euZwR/Po6Op50tmceiw="
          ota_password: "dummy-ota-password"
          EOF

      - name: Validate config
        id: validate
        run: |
          set -o pipefail
          esphome config "${{ matrix.config.file }}" 2>&1 | tee esphome.log

      - name: Save resolved config
        if: success()
        run: |
          esphome config "${{ matrix.config.file }}" > resolved-config.txt

      - name: Upload log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: esphome-log-${{ matrix.config.friendly_name }}
          path: esphome.log
          if-no-files-found: ignore

      - name: Upload resolved config
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: esphome-config-${{ matrix.config.friendly_name }}
          path: resolved-config.txt
          if-no-files-found: ignore

      - name: Add result to summary
        if: always()
        uses: actions/github-script@v7
        env:
          CONFIG_NAME: ${{ matrix.config.friendly_name }}
          CONFIG_FILE: ${{ matrix.config.file }}
          JOB_STATUS: ${{ job.status }}
        with:
          script: |-
            const fs = require('fs');
            const {
              CONFIG_NAME,
              CONFIG_FILE,
              JOB_STATUS,
              GITHUB_SERVER_URL,
              GITHUB_REPOSITORY,
              GITHUB_RUN_ID,
            } = process.env;

            const ok = JOB_STATUS === 'success';
            const icon = ok ? '‚úÖ' : '‚ùå';

            let summary = `${icon} ${CONFIG_NAME} (\`${CONFIG_FILE}\`) - ${JOB_STATUS}\n\n`;

            if (!ok) {
              try {
                const lines = fs.readFileSync('esphome.log', 'utf8').split('\n');
                const tail = lines.slice(-40).join('\n');
                summary += 'Last lines of log:\n\n';
                summary += '```text\n' + tail + '\n```\n\n';
              } catch (err) {
                core.warning(`Could not read esphome.log: ${err.message}`);
              }
            }

            const runUrl = `${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}`;
            summary += `[View full logs for this run](${runUrl})\n\n`;
            summary += `Artifacts:\n`;
            summary += `- \`esphome-log-${CONFIG_NAME}\` (full log)\n`;
            if (ok) {
              summary += `- \`esphome-config-${CONFIG_NAME}\` (resolved/validated config)\n`;
            }

            core.summary.addRaw(summary).write();
